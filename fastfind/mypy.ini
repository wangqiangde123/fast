# fix_all_issues.ps1 - ä¿®å¤æ‰€æœ‰ä»£ç è´¨é‡é—®é¢˜
Write-Host "å¼€å§‹ä¿®å¤æ‰€æœ‰ä»£ç è´¨é‡é—®é¢˜..." -ForegroundColor Green
Write-Host "="*60 -ForegroundColor Cyan

# 1. ç¡®ä¿åœ¨é¡¹ç›®ç›®å½•
$projectRoot = Get-Location
Write-Host "é¡¹ç›®ç›®å½•: $projectRoot" -ForegroundColor Yellow

# 2. å®‰è£…å¿…è¦çš„å·¥å…·
Write-Host "`nå®‰è£…ä»£ç è´¨é‡å·¥å…·..." -ForegroundColor Yellow
$tools = @("autopep8", "isort", "pylint")
foreach ($tool in $tools) {
    Write-Host "  æ£€æŸ¥ $tool..." -ForegroundColor Gray -NoNewline
    $installed = pip show $tool 2>$null
    if ($installed) {
        Write-Host " âœ… å·²å®‰è£…" -ForegroundColor Green
    } else {
        Write-Host " ğŸ“¦ å®‰è£…ä¸­..." -ForegroundColor Yellow -NoNewline
        pip install $tool 2>$null
        if ($LASTEXITCODE -eq 0) {
            Write-Host " âœ…" -ForegroundColor Green
        } else {
            Write-Host " âŒ" -ForegroundColor Red
        }
    }
}

# 3. ä¿®å¤æ–‡ä»¶ç¼–ç ï¼ˆç¬¬ä¸€æ­¥ï¼‰
Write-Host "`nä¿®å¤æ–‡ä»¶ç¼–ç ..." -ForegroundColor Yellow
$pythonFiles = Get-ChildItem src/fastfind -Recurse -Filter *.py
$pythonFiles += Get-ChildItem tests -Recurse -Filter *.py -ErrorAction SilentlyContinue

foreach ($file in $pythonFiles) {
    $firstLine = Get-Content $file.FullName -First 1 -ErrorAction SilentlyContinue
    if ($firstLine -and $firstLine -notmatch '^#.*coding|^#!/') {
        $content = Get-Content $file.FullName -Raw -ErrorAction SilentlyContinue
        if ($content) {
            "# -*- coding: utf-8 -*-`n`n" + $content | Out-File $file.FullName -Encoding UTF8
            Write-Host "  âœ… ä¿®å¤ç¼–ç : $($file.Name)" -ForegroundColor Gray
        }
    }
}

# 4. è¿è¡Œblackæ ¼å¼åŒ–
Write-Host "`nè¿è¡Œblackæ ¼å¼åŒ–..." -ForegroundColor Yellow
black src/fastfind tests 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  âœ… blackæ ¼å¼åŒ–å®Œæˆ" -ForegroundColor Green
} else {
    Write-Host "  âš ï¸  blacké‡åˆ°é—®é¢˜ï¼Œç»§ç»­å…¶ä»–ä¿®å¤" -ForegroundColor Yellow
}

# 5. ä¿®å¤å¯¼å…¥é¡ºåº
Write-Host "`nä¿®å¤å¯¼å…¥é¡ºåº..." -ForegroundColor Yellow
isort src/fastfind tests --profile black 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  âœ… å¯¼å…¥é¡ºåºä¿®å¤å®Œæˆ" -ForegroundColor Green
}

# 6. ä½¿ç”¨autopep8ä¿®å¤å¸¸è§é—®é¢˜
Write-Host "`nä½¿ç”¨autopep8ä¿®å¤ä»£ç é£æ ¼..." -ForegroundColor Yellow
autopep8 --in-place --recursive --aggressive src/fastfind tests 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  âœ… autopep8ä¿®å¤å®Œæˆ" -ForegroundColor Green
}

# 7. æ‰‹åŠ¨ä¿®å¤å‰©ä½™é—®é¢˜
Write-Host "`næ‰‹åŠ¨ä¿®å¤å¸¸è§é—®é¢˜..." -ForegroundColor Yellow

# ä¿®å¤å¸¸è§çš„flake8é—®é¢˜
function Fix-Flake8Issues {
    param([string]$Directory)
    
    Get-ChildItem $Directory -Recurse -Filter *.py | ForEach-Object {
        $file = $_.FullName
        $content = Get-Content $file -Raw
        
        # ä¿®å¤è¡Œå¤ªé•¿çš„é—®é¢˜ï¼ˆç®€å•å¤„ç†ï¼‰
        $lines = $content -split "`n"
        $fixedLines = @()
        
        foreach ($line in $lines) {
            if ($line.Length -gt 88) {
                # å°è¯•åœ¨é€—å·åæ¢è¡Œ
                if ($line.Contains(', ')) {
                    $parts = $line.Split(', ')
                    $newLine = $parts[0]
                    for ($i = 1; $i -lt $parts.Count; $i++) {
                        if ($newLine.Length + $parts[$i].Length + 2 -gt 88) {
                            $fixedLines += $newLine + ','
                            $newLine = "    " + $parts[$i]
                        } else {
                            $newLine += ', ' + $parts[$i]
                        }
                    }
                    $fixedLines += $newLine
                } else {
                    $fixedLines += $line
                }
            } else {
                $fixedLines += $line
            }
        }
        
        $fixedContent = $fixedLines -join "`n"
        if ($fixedContent -ne $content) {
            $fixedContent | Out-File $file -Encoding UTF8
            Write-Host "  ğŸ“ ä¿®å¤è¡Œå¤ªé•¿: $($_.Name)" -ForegroundColor Gray
        }
    }
}

Fix-Flake8Issues -Directory "src/fastfind"
if (Test-Path "tests") {
    Fix-Flake8Issues -Directory "tests"
}

# 8. å†æ¬¡è¿è¡Œblackç¡®ä¿æ ¼å¼ä¸€è‡´
Write-Host "`nå†æ¬¡è¿è¡Œblackç¡®ä¿æ ¼å¼ä¸€è‡´..." -ForegroundColor Yellow
black src/fastfind tests --check 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  âœ… ä»£ç æ ¼å¼æ­£ç¡®" -ForegroundColor Green
} else {
    Write-Host "  âš ï¸  ä»æœ‰æ ¼å¼é—®é¢˜ï¼Œå°è¯•å†æ¬¡æ ¼å¼åŒ–" -ForegroundColor Yellow
    black src/fastfind tests 2>&1
}

# 9. è¿è¡Œflake8æ£€æŸ¥å‰©ä½™é—®é¢˜
Write-Host "`nè¿è¡Œflake8æ£€æŸ¥å‰©ä½™é—®é¢˜..." -ForegroundColor Yellow
$flake8Output = flake8 src/fastfind tests --max-line-length=88 --exit-zero 2>&1
if ($flake8Output) {
    Write-Host "  âš ï¸  å‘ç°ä»¥ä¸‹é—®é¢˜:" -ForegroundColor Yellow
    $flake8Output | ForEach-Object { Write-Host "    $_" -ForegroundColor Gray }
} else {
    Write-Host "  âœ… æ²¡æœ‰flake8é—®é¢˜" -ForegroundColor Green
}

# 10. ç®€åŒ–mypyæ£€æŸ¥
Write-Host "`né…ç½®mypyå¿½ç•¥å¤æ‚ç±»å‹..." -ForegroundColor Yellow
# åˆ›å»ºmypyé…ç½®æ–‡ä»¶
@'
[mypy]
python_version = 3.8
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = False
ignore_missing_imports = True
exclude = '.*/__pycache__/.*'

[mypy-fastfind.scanner.*]
ignore_errors = True

[mypy-fastfind.filters.*]
ignore_errors = True

[mypy-fastfind.cache.*]
ignore_errors = True
